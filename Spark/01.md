# Spark
ê¶ê¸ˆí•œ/ëª¨í˜¸í•œ ê°œë…ë“¤ê³¼ í•´ë‹µì„ ì°¾ê¸° ìœ„í•œ ì‚½ì§ˆ, ë‚˜ë¦„ì˜ ê²°ë¡ 

<details>
   <summary><strong><span style="font-size:110%">
     saveAsTable() - save modes
   </span></strong></summary>
<hr>
   <p>

   - DataFrameì„ í…Œì´ë¸”ë¡œ ì €ì¥(~materialize)í•œë‹¤.
  
   - Hive MetaStore (spark.sql.warehouse.dir)ì— **ì˜êµ¬ í…Œì´ë¸”ë¡œ ì €ì¥**í•œë‹¤ëŠ” ê²ƒ
     - ğŸ¤”Â ê·¸ëŸ¼ Hiveê°€ ì„¤ì¹˜ë˜ì–´ìˆì–´ì•¼ í•˜ëŠ”ê±´ê°€? 
     - ë†‰ ìŠ¤íŒŒí¬ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ local Hive metastoreë¥¼ ìƒì„±í•˜ê¸° ë•Œë¬¸ì—, Hive ë°°í¬ ì—¬ë¶€ì™€ëŠ” ë¬´ê´€í•˜ë‹¤.
   - `CreateOrReplaceTempView` ì»¤ë§¨ë“œì™€ ë‹¬ë¦¬ `saveAsTable`ì€ DataFrameì˜ ë‚´ìš©(ë°ì´í„°)ë“¤ì„ **materializeí•˜ê³ **, ë°ì´í„°ì— ëŒ€í•œ **í¬ì¸í„°**ë¥¼ **Hive metastore**ì— ìƒì„±
   - ë”°ë¼ì„œ spark í”„ë¡œê·¸ë¨ì´ ë‹¤ì‹œ ì‹œì‘ëë”ë¼ë„, í…Œì´ë¸”ë“¤ì´ ì˜êµ¬ì ìœ¼ë¡œ ì¡´ì¬í•˜ê²Œ ë˜ê³ , ì´ ë§¥ë½ì—ì„œ "ì˜êµ¬ í…Œì´ë¸”ë¡œ ì €ì¥" í•œë‹¤ëŠ” ê²ƒì´ë‹¤.
   - ì˜êµ¬ í…Œì´ë¸”ë¡œ ì €ì¥í–ˆìœ¼ë‹ˆê¹ SparkSessionì˜ table ë©”ì†Œë“œì„ ì‚¬ìš©í•´ì„œ DataFrameìœ¼ë¡œ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆë‹¤.
   </p>
<hr>
</details>

<br>

<details>
   <summary><strong><span style="font-size:110%">
     Spark uiì—ì„œ DAG visualizationì„ ë³´ë©´ DAGë¥¼ ê°€ì§€ê³  ìŠ¤ì¼€ì¤„ë§ì„ í•˜ëŠ” ê²ƒ ê°™ì€ë°, catalyst optimizerê³¼ ê´€ë ¨ì´ ìˆëŠ”ê±´ê°€?
   </span></strong></summary>
<hr>
   <p>
   
   - Catalyst Optimizer ì™€ Dag scheduler ë‘˜ ë‹¤ physical execution planì„ ìƒì„±í•œë‹¤ëŠ” ì ì—ì„œ ìœ ì‚¬í•´ì„œ, í˜¼ë€ìŠ¤ëŸ¬ì› ë‹¤.
  
  Catalyst Optimizer

   - ì‚¬ìš©ìì˜ ì¿¼ë¦¬ì™€(ì •í™•í•˜ê²ŒëŠ” SQL íŒŒì„œê°€ ë°˜í™˜í•œ ì¶”ìƒ êµ¬ë¬¸ íŠ¸ë¦¬) DF/DSë¥¼ ë°›ì•„ì„œ **ìµœì ì˜ physical planì„ ê³¨ë¼ RDD Dag** ë¥¼ ìƒì„±
   
   Dag Scheduler

   - ì´ RDD Dagë¥¼ ë°›ì•„ì„œ **stage ë‹¨ìœ„**ë¡œ **physical execution planì„ ìƒì„±**í•´ Task Schedulerì— ì „ë‹¬í•œë‹¤. 
   - spark ui ì—ì„œ í™•ì¸ ê°€ëŠ¥í•œ Dag visualization ì€ ì´ stageì˜ ì„¸ë¶€ ì •ë³´ë¡œì¨ RDDì™€ operation ì •ë³´ë¥¼ ê·¸ë˜í”„ë¡œ ë³´ì—¬ì£¼ê³  ìˆëŠ” ê²ƒ !

![img](image/catalyst_to_dag_scheduler.png)
   </p>
<hr>
</details>

<br>

<details>
   <summary><strong><span style="font-size:110%">
     wide transformation vs narrow transformation
   </span></strong></summary>
<hr>
   <p>
  
   - spark uiì—ì„œ í™•ì¸í–ˆì„ ë–¼, groupBy ì—°ì‚° ì‹œ(  count = user.groupBy("gender").count()  ) Shuffle Read, Shuffle writeì— ê±¸ë¦° ì‹œê°„ì´ ë‚˜ì˜¤ëŠ” ê±¸ í™•ì¸í•  ìˆ˜ ìˆì—ˆë‹¤.
   - ì´ jobì€ group by ì—°ì‚°ì„ ìœ„í•´ **shuffling**ì´ ë°œìƒí•œ **wide transformation**ì´ê¸° ë•Œë¬¸ì—, ì´ëŸ¬í•œ ê²°ê³¼ê°€ ë‚˜ì˜¨ ê²ƒ
   - shuffling ë°œìƒ ì—°ì‚° 
      : repatitioningì„ ìœ ë°œí•˜ëŠ” ì—°ì‚°ì€Â ì¡°ì¸, ë¦¬ë“€ìŠ¤, ê·¸ë£¹í•‘, ì§‘ê³„ ì—°ì‚°
     - groupByKey(), reduceByKey(), join(), union(), groupBy()
   - narrow transformation jobê³¼ ë¹„êµí•´ì„œ ì •ë¦¬í•´ë´¤ë‹¤.
  ![img](image/narrow_transformation.png)
  ![img](image/wide_transformation.png)
   </p>
<hr>
</details>

<br>

<details>
   <summary><strong><span style="font-size:110%">
     groupbyKey() vs reducebyKey()
   </span></strong></summary>
<hr>
   <p>
   
   - ë‘˜ ë‹¤ wide transformationìœ¼ë¡œ, `shuffle operation`ì„ íŠ¸ë¦¬ê±°í•œë‹¤.
   - ì°¨ì´ì ì€ `reduceByKey()`ëŠ” `map side combine`, `groupByKey()`ëŠ” ì•„ë‹˜

   RED GREEN RED RED ì´ lineì„ ê°–ê³ ìˆëŠ” íŒŒì¼ì„ wordcount ê³„ì‚°í•´ì•¼í•˜ê³ , ëŸ°íƒ€ì„ì— 2ê°œì˜ partitions ìœ¼ë¡œ ëë‚œë‹¤ê³  ê°€ì •í•˜ì.

   ```
   Partition 1
   RED
   GREEN
   Partition 2
   RED
   RED
   ```
<details>
   <summary><strong><span style="font-size:110%">
   groupByKey()
   </span></strong></summary>
<hr>
   <p>
      2ê°œì˜ íŒŒí‹°ì…˜ì´ ìˆìœ¼ë¯€ë¡œ 2ê°œì˜ ì‘ì—…ìœ¼ë¡œ ëë‚¸ë‹¤. 

   Task outputs

   ```
   Task 1
   RED, 1
   GREEN, 1
   Task 2
   RED, 1
   RED, 1
   ```

   ì‘ì—… 1, 2ì˜ ëª¨ë“  ìš”ì†ŒëŠ” ë„¤íŠ¸ì›Œí¬ë¥¼ í†µí•´ `reduce operation`ì„ ìˆ˜í–‰í•˜ëŠ” ì‘ì—…ìœ¼ë¡œ ì „ì†¡ëœë‹¤.

   Task performing reduce

   ```
   RED, 1
   GREEN, 1
   RED, 1
   RED, 1
   ```

   Yielding the result

   ```
   GREEN 1
   RED 3
   ```
   ë¬¸ì œì  1. ë°ì´í„°ê°€ map sideì—ì„œ combined/reducedë˜ì§€ ì•Šê¸° ë•Œë¬¸ì—, shuffle í•˜ëŠ” ë™ì•ˆ ë„¤íŠ¸ì›Œí¬ í†µí•´ì„œ ì´ ëª¨ë“  elementë“¤ì„ ë‹¤ ì „ì†¡í•´ì•¼í•œë‹¤.

   ë¬¸ì œì  2. ëª¨ë“  elementë“¤ì´ aggregate ì—°ì‚°ì„ ìˆ˜í–‰í•˜ëŠ” taskì—ê²Œ ë³´ë‚´ì§€ê¸° ë•Œë¬¸ì—, taskì—ì„œ ì²˜ë¦¬í•´ì•¼ í•  ìš”ì†Œê°€ ë” ë§ì•„ì§€ê³  ë©”ëª¨ë¦¬ ë¶€ì¡± ì˜ˆì™¸ê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.
   </p>
<hr>
</details>

<details>
   <summary><strong><span style="font-size:110%">
   reduceByKey()
   </span></strong></summary>
<hr>
   <p>

reduceByKey()ëŠ” `map side combine`ìœ¼ë¡œ `ìµœì í™”`ë˜ì—ˆë‹¤.

ìœ„ì™€ ë˜‘ê°™ì´ 2ê°œì˜ partitionì´ê¸° ë•Œë¬¸ì— 2ê°œì˜ taskë¡œ ëë‚œë‹¤. ê·¼ë° map side combineì´ê¸° ë•Œë¬¸ì—, task ì¶œë ¥í•´ë³´ë©´ ì´ë ‡ë‹¤.

```
Task 1
RED, 1
GREEN, 1
Task 2
RED, 2
```

ì‘ì—… 1, 2ì˜ ë‹¨ 3ê°œì˜ elementsë§Œ `reduce operation`ì„ ìˆ˜í–‰í•˜ëŠ” ì‘ì—…ì—ê²Œ ë„¤íŠ¸ì›Œí¬ë¥¼ í†µí•´ ì „ì†¡ëœë‹¤.

Task performing reduce

```
RED, 1
GREEN, 1
RED, 2
```

yielding the result

```
GREEN 1
RED 3
```
map side aggreagateë¡œ ì¸í•´ reduceByKey()ê°€ ìµœì í™”ëœë‹¤. ë„¤íŠ¸ì›Œí¬ë¥¼ í†µí•´ ì „ì†¡ë˜ëŠ” ìš”ì†Œ ìˆ˜ê°€ í™• ì¤„ì–´ë“ ë‹¤. 

shuffle ì´í›„ reduce ì—°ì‚°ì„ ìˆ˜í–‰í•˜ëŠ” taskì—ì„œ ë” ì ì€ ìˆ˜ì˜ elementsê°€ reduceëœë‹¤
   </p>
<hr>
</details>

   </p>
<hr>
</details>

<br>

<details>
   <summary><strong><span style="font-size:110%">
     
   </span></strong></summary>
<hr>
   <p>
   
   </p>
<hr>
</details>

<br>

<details>
   <summary><strong><span style="font-size:110%">
     
   </span></strong></summary>
<hr>
   <p>
   
   </p>
<hr>
</details>